<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Today in History</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Georgia', serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide icons as SVG components
        const Calendar = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const Filter = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
        );

        const Star = ({ filled }) => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill={filled ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
            </svg>
        );

        const ChevronLeft = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        );

        const ChevronRight = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        );

        const Loader = () => (
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="animate-spin">
                <line x1="12" y1="2" x2="12" y2="6"></line>
                <line x1="12" y1="18" x2="12" y2="22"></line>
                <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
                <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
                <line x1="2" y1="12" x2="6" y2="12"></line>
                <line x1="18" y1="12" x2="22" y2="12"></line>
                <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
                <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
            </svg>
        );

        const TodayInHistory = () => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [events, setEvents] = useState([]);
            const [loading, setLoading] = useState(true);
            const [favorites, setFavorites] = useState([]);
            const [showFilters, setShowFilters] = useState(false);
            const [selectedFilters, setSelectedFilters] = useState({
                eventTypes: [],
                timePeriods: []
            });

            const eventTypes = [
                'Birth', 'Death', 'War', 'Battle', 'Marriage', 'Treaty', 
                'Religious', 'Publication', 'Invention', 'Discovery', 
                'Architecture', 'Coronation', 'Natural Disaster'
            ];

            const timePeriods = [
                { name: 'Prehistory', range: 'Before 3000 BCE' },
                { name: 'Ancient', range: '3000 BCE - 500 CE' },
                { name: 'Medieval', range: '500 - 1500 CE' },
                { name: 'Early Modern', range: '1500 - 1789' },
                { name: 'Modern', range: '1789 onwards' }
            ];

            // Load favorites from localStorage
            useEffect(() => {
                const saved = localStorage.getItem('history-favorites');
                if (saved) {
                    setFavorites(JSON.parse(saved));
                }
            }, []);

            // Save favorites to localStorage
            useEffect(() => {
                localStorage.setItem('history-favorites', JSON.stringify(favorites));
            }, [favorites]);

            // Fetch events when date changes
            useEffect(() => {
                fetchHistoricalEvents();
            }, [currentDate]);

            const getTimePeriod = (year) => {
                if (year < -3000) return 'Prehistory';
                if (year < 500) return 'Ancient';
                if (year < 1500) return 'Medieval';
                if (year < 1789) return 'Early Modern';
                return 'Modern';
            };

            const categorizeEvent = (text, year) => {
                const lowerText = text.toLowerCase();
                
                if (lowerText.includes('born') || lowerText.includes('birth')) return 'Birth';
                if (lowerText.includes('died') || lowerText.includes('death')) return 'Death';
                if (lowerText.includes('war') || lowerText.includes('declare')) return 'War';
                if (lowerText.includes('battle') || lowerText.includes('fought')) return 'Battle';
                if (lowerText.includes('married') || lowerText.includes('marriage') || lowerText.includes('wedding')) return 'Marriage';
                if (lowerText.includes('treaty') || lowerText.includes('peace') || lowerText.includes('agreement')) return 'Treaty';
                if (lowerText.includes('church') || lowerText.includes('pope') || lowerText.includes('religious') || lowerText.includes('schism')) return 'Religious';
                if (lowerText.includes('published') || lowerText.includes('publication') || lowerText.includes('book')) return 'Publication';
                if (lowerText.includes('invented') || lowerText.includes('patent') || lowerText.includes('invention')) return 'Invention';
                if (lowerText.includes('discovered') || lowerText.includes('discovery') || lowerText.includes('explored')) return 'Discovery';
                if (lowerText.includes('built') || lowerText.includes('completed') || lowerText.includes('constructed') || lowerText.includes('cathedral') || lowerText.includes('temple')) return 'Architecture';
                if (lowerText.includes('crowned') || lowerText.includes('coronation') || lowerText.includes('became king') || lowerText.includes('became queen')) return 'Coronation';
                if (lowerText.includes('earthquake') || lowerText.includes('flood') || lowerText.includes('volcano') || lowerText.includes('disaster')) return 'Natural Disaster';
                
                return 'Other';
            };

            const fetchHistoricalEvents = async () => {
                setLoading(true);
                const month = currentDate.getMonth() + 1;
                const day = currentDate.getDate();
                
                try {
                    // Fetch from Wikipedia's "On This Day" API
                    const onThisDayUrl = `https://api.wikimedia.org/feed/v1/wikipedia/en/onthisday/all/${String(month).padStart(2, '0')}/${String(day).padStart(2, '0')}`;
                    
                    const response = await fetch(onThisDayUrl);
                    const data = await response.json();
                    
                    let allEvents = [];
                    
                    // Process all event types from Wikipedia
                    if (data.events) allEvents = allEvents.concat(data.events.map(e => ({ ...e, type: 'event' })));
                    if (data.births) allEvents = allEvents.concat(data.births.map(e => ({ ...e, type: 'birth' })));
                    if (data.deaths) allEvents = allEvents.concat(data.deaths.map(e => ({ ...e, type: 'death' })));
                    
                    // Process and enrich events
                    const processedEvents = allEvents.map(event => {
                        const year = event.year;
                        const text = event.text || event.pages?.[0]?.extract || 'Historical event';
                        const title = event.pages?.[0]?.titles?.normalized || event.pages?.[0]?.title || text;
                        const url = event.pages?.[0]?.content_urls?.desktop?.page || '';
                        
                        return {
                            year: year,
                            text: text.substring(0, 200) + (text.length > 200 ? '...' : ''),
                            title: title,
                            url: url,
                            category: categorizeEvent(text, year),
                            period: getTimePeriod(year),
                            id: `${year}-${title.substring(0, 20)}`.replace(/\s/g, '-')
                        };
                    });
                    
                    // Weight toward ancient history
                    const weighted = weightEvents(processedEvents);
                    
                    // Select 15-20 events with diversity
                    const selected = selectDiverseEvents(weighted, 15 + Math.floor(Math.random() * 6));
                    
                    // Sort by year (oldest first)
                    selected.sort((a, b) => a.year - b.year);
                    
                    setEvents(selected);
                } catch (error) {
                    console.error('Error fetching events:', error);
                    // Fallback to sample data
                    setEvents(generateSampleEvents(month, day));
                }
                
                setLoading(false);
            };

            const weightEvents = (events) => {
                // Weight events: older events get higher weight
                return events.map(event => {
                    let weight = 1;
                    const year = event.year;
                    
                    if (year < -3000) weight = 10; // Prehistory
                    else if (year < 0) weight = 8; // Ancient BCE
                    else if (year < 500) weight = 7; // Ancient CE
                    else if (year < 1000) weight = 5; // Early Medieval
                    else if (year < 1500) weight = 4; // Late Medieval
                    else if (year < 1789) weight = 3; // Early Modern
                    else if (year < 1900) weight = 2; // Modern
                    else weight = 1; // Contemporary
                    
                    return { ...event, weight };
                });
            };

            const selectDiverseEvents = (weightedEvents, count) => {
                const selected = [];
                const categories = {};
                const periods = {};
                
                // Create weighted pool (add events multiple times based on weight)
                const pool = [];
                weightedEvents.forEach(event => {
                    for (let i = 0; i < event.weight; i++) {
                        pool.push(event);
                    }
                });
                
                // Shuffle pool
                for (let i = pool.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [pool[i], pool[j]] = [pool[j], pool[i]];
                }
                
                // Select diverse events
                for (const event of pool) {
                    if (selected.length >= count) break;
                    
                    // Check if we already have too many of this category or period
                    const catCount = categories[event.category] || 0;
                    const periodCount = periods[event.period] || 0;
                    
                    // Allow more events from underrepresented categories
                    if (catCount < 4 && periodCount < 8) {
                        // Avoid duplicates
                        if (!selected.find(e => e.id === event.id)) {
                            selected.push(event);
                            categories[event.category] = catCount + 1;
                            periods[event.period] = periodCount + 1;
                        }
                    }
                }
                
                return selected;
            };

            const generateSampleEvents = (month, day) => {
                // Fallback sample data
                return [
                    {
                        year: -3100,
                        text: 'Traditional date for the unification of Upper and Lower Egypt under Narmer (Menes), marking the beginning of the First Dynasty.',
                        title: 'Unification of Egypt',
                        category: 'Coronation',
                        period: 'Ancient',
                        id: 'sample-1',
                        url: 'https://en.wikipedia.org/wiki/Narmer'
                    },
                    {
                        year: -776,
                        text: 'First recorded Olympic Games held in Olympia, Greece, marking the beginning of the ancient Olympic tradition.',
                        title: 'First Olympic Games',
                        category: 'Other',
                        period: 'Ancient',
                        id: 'sample-2',
                        url: 'https://en.wikipedia.org/wiki/Ancient_Olympic_Games'
                    },
                    {
                        year: 312,
                        text: 'Battle of the Milvian Bridge: Constantine I defeats Maxentius, leading to his conversion to Christianity.',
                        title: 'Battle of Milvian Bridge',
                        category: 'Battle',
                        period: 'Ancient',
                        id: 'sample-3',
                        url: 'https://en.wikipedia.org/wiki/Battle_of_the_Milvian_Bridge'
                    }
                ];
            };

            const formatDate = (year) => {
                if (year < 0) {
                    return `${Math.abs(year)} BCE`;
                }
                return `${year} CE`;
            };

            const formatDisplayDate = (date) => {
                return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
            };

            const changeDate = (days) => {
                const newDate = new Date(currentDate);
                newDate.setDate(newDate.getDate() + days);
                setCurrentDate(newDate);
            };

            const toggleFavorite = (eventId) => {
                if (favorites.includes(eventId)) {
                    setFavorites(favorites.filter(id => id !== eventId));
                } else {
                    setFavorites([...favorites, eventId]);
                }
            };

            const toggleFilter = (type, value) => {
                const current = selectedFilters[type];
                if (current.includes(value)) {
                    setSelectedFilters({
                        ...selectedFilters,
                        [type]: current.filter(v => v !== value)
                    });
                } else {
                    setSelectedFilters({
                        ...selectedFilters,
                        [type]: [...current, value]
                    });
                }
            };

            const filteredEvents = events.filter(event => {
                if (selectedFilters.eventTypes.length > 0 && !selectedFilters.eventTypes.includes(event.category)) {
                    return false;
                }
                if (selectedFilters.timePeriods.length > 0 && !selectedFilters.timePeriods.includes(event.period)) {
                    return false;
                }
                return true;
            });

            return (
                <div className="min-h-screen bg-gradient-to-br from-amber-50 via-yellow-50 to-orange-50 p-4">
                    {/* Parchment texture overlay */}
                    <div className="fixed inset-0 opacity-30 pointer-events-none" style={{
                        backgroundImage: `url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' /%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.3' fill='%23d2691e'/%3E%3C/svg%3E")`,
                        backgroundSize: '200px 200px'
                    }}></div>

                    <div className="max-w-2xl mx-auto relative">
                        {/* Ornate Header */}
                        <div className="text-center mb-8 relative">
                            <div className="absolute inset-0 flex items-center justify-center opacity-10">
                                <div className="text-9xl">ðŸ“œ</div>
                            </div>
                            <h1 className="text-5xl font-serif text-amber-900 mb-2 relative" style={{ textShadow: '2px 2px 4px rgba(139,69,19,0.3)' }}>
                                Today in History
                            </h1>
                            <div className="flex items-center justify-center gap-2 text-amber-800">
                                <div className="h-px bg-amber-600 w-16"></div>
                                <Calendar />
                                <div className="h-px bg-amber-600 w-16"></div>
                            </div>
                        </div>

                        {/* Date Navigation */}
                        <div className="bg-gradient-to-r from-amber-100 to-yellow-100 rounded-lg border-4 border-double border-amber-700 p-4 mb-6 shadow-lg">
                            <div className="flex items-center justify-between">
                                <button
                                    onClick={() => changeDate(-1)}
                                    className="p-2 hover:bg-amber-200 rounded-full transition-colors"
                                    aria-label="Previous day"
                                >
                                    <ChevronLeft />
                                </button>
                                
                                <div className="text-center">
                                    <div className="text-2xl font-serif text-amber-900 font-bold">
                                        {formatDisplayDate(currentDate)}
                                    </div>
                                    <button
                                        onClick={() => setCurrentDate(new Date())}
                                        className="text-sm text-amber-700 hover:text-amber-900 underline mt-1"
                                    >
                                        Return to Today
                                    </button>
                                </div>
                                
                                <button
                                    onClick={() => changeDate(1)}
                                    className="p-2 hover:bg-amber-200 rounded-full transition-colors"
                                    aria-label="Next day"
                                >
                                    <ChevronRight />
                                </button>
                            </div>
                        </div>

                        {/* Filter Toggle */}
                        <div className="mb-4">
                            <button
                                onClick={() => setShowFilters(!showFilters)}
                                className="w-full bg-gradient-to-r from-yellow-100 to-amber-100 border-2 border-amber-600 rounded-lg p-3 flex items-center justify-center gap-2 hover:from-yellow-200 hover:to-amber-200 transition-colors shadow"
                            >
                                <Filter />
                                <span className="font-serif text-amber-900 font-semibold">
                                    {showFilters ? 'Hide Filters' : 'Show Filters'}
                                </span>
                            </button>
                        </div>

                        {/* Filters */}
                        {showFilters && (
                            <div className="bg-gradient-to-br from-amber-50 to-yellow-50 border-2 border-amber-600 rounded-lg p-4 mb-6 shadow-lg">
                                <div className="mb-4">
                                    <h3 className="font-serif text-lg text-amber-900 font-bold mb-2">Event Types</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {eventTypes.map(type => (
                                            <button
                                                key={type}
                                                onClick={() => toggleFilter('eventTypes', type)}
                                                className={`px-3 py-1 rounded-full text-sm font-serif transition-colors border-2 ${
                                                    selectedFilters.eventTypes.includes(type)
                                                        ? 'bg-amber-700 text-white border-amber-900'
                                                        : 'bg-amber-100 text-amber-800 border-amber-400 hover:bg-amber-200'
                                                }`}
                                            >
                                                {type}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 className="font-serif text-lg text-amber-900 font-bold mb-2">Time Periods</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {timePeriods.map(period => (
                                            <button
                                                key={period.name}
                                                onClick={() => toggleFilter('timePeriods', period.name)}
                                                className={`px-3 py-1 rounded-full text-sm font-serif transition-colors border-2 ${
                                                    selectedFilters.timePeriods.includes(period.name)
                                                        ? 'bg-amber-700 text-white border-amber-900'
                                                        : 'bg-amber-100 text-amber-800 border-amber-400 hover:bg-amber-200'
                                                }`}
                                            >
                                                {period.name}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Loading State */}
                        {loading && (
                            <div className="flex items-center justify-center py-12">
                                <Loader />
                                <span className="ml-3 font-serif text-amber-900">Unearthing historical treasures...</span>
                            </div>
                        )}

                        {/* Events List */}
                        {!loading && (
                            <div className="space-y-4">
                                {filteredEvents.length === 0 ? (
                                    <div className="bg-gradient-to-br from-amber-50 to-yellow-50 border-2 border-amber-600 rounded-lg p-6 text-center">
                                        <p className="font-serif text-amber-900">No events match your selected filters.</p>
                                    </div>
                                ) : (
                                    filteredEvents.map((event, index) => (
                                        <div
                                            key={event.id}
                                            className="bg-gradient-to-br from-amber-50 via-yellow-50 to-orange-50 border-4 border-double border-amber-700 rounded-lg p-5 shadow-lg hover:shadow-xl transition-shadow relative overflow-hidden"
                                        >
                                            {/* Decorative corner ornaments */}
                                            <div className="absolute top-0 left-0 w-8 h-8 border-l-4 border-t-4 border-amber-600 opacity-40"></div>
                                            <div className="absolute top-0 right-0 w-8 h-8 border-r-4 border-t-4 border-amber-600 opacity-40"></div>
                                            <div className="absolute bottom-0 left-0 w-8 h-8 border-l-4 border-b-4 border-amber-600 opacity-40"></div>
                                            <div className="absolute bottom-0 right-0 w-8 h-8 border-r-4 border-b-4 border-amber-600 opacity-40"></div>
                                            
                                            <div className="flex items-start justify-between gap-3">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-2 flex-wrap">
                                                        <span className="font-serif text-2xl font-bold text-amber-900">
                                                            {formatDate(event.year)}
                                                        </span>
                                                        <span className="px-2 py-1 bg-amber-200 border border-amber-600 rounded text-xs font-serif text-amber-900">
                                                            {event.category}
                                                        </span>
                                                        <span className="px-2 py-1 bg-yellow-200 border border-yellow-600 rounded text-xs font-serif text-amber-900">
                                                            {event.period}
                                                        </span>
                                                    </div>
                                                    
                                                    <p className="font-serif text-amber-900 leading-relaxed mb-3">
                                                        {event.text}
                                                    </p>
                                                    
                                                    {event.url && (
                                                        <a
                                                            href={event.url}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            className="inline-flex items-center gap-1 text-amber-700 hover:text-amber-900 font-serif text-sm underline"
                                                        >
                                                            Read more on Wikipedia â†’
                                                        </a>
                                                    )}
                                                </div>
                                                
                                                <button
                                                    onClick={() => toggleFavorite(event.id)}
                                                    className="p-2 hover:bg-amber-200 rounded-full transition-colors flex-shrink-0"
                                                    aria-label="Toggle favorite"
                                                >
                                                    <Star filled={favorites.includes(event.id)} />
                                                </button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {/* Footer ornament */}
                        <div className="mt-12 mb-6 flex items-center justify-center">
                            <div className="h-px bg-amber-600 w-24"></div>
                            <div className="mx-4 text-amber-700 text-2xl">âœ¦</div>
                            <div className="h-px bg-amber-600 w-24"></div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<TodayInHistory />, document.getElementById('root'));
    </script>
</body>
</html>
